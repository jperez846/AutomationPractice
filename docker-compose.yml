version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: product-app-backend:latest
    container_name: backend
    ports:
      - "8080:8080"
      - "9092:9092"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-default}
      JAVA_OPTS: '-Xmx512m -Xms256m'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    networks:
      - app-network

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    image: product-app-frontend:latest
    container_name: frontend
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - app-network

  selenium-hub:
    image: selenium/hub:4.16.1
    platform: linux/amd64
    container_name: selenium-hub
    ports:
      - "4444:4444"
      - "4442:4442"
      - "4443:4443"
    environment:
      GRID_MAX_SESSION: 5
      SE_SESSION_REQUEST_TIMEOUT: 300
      SE_SESSION_TIMEOUT: 300
      SE_NODE_HEARTBEAT_PERIOD: 30000
      SE_LOG_LEVEL: INFO
      SE_STRUCTURED_LOGS: 'false'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - app-network

  chrome:
    image: selenium/node-chrome:4.16.1
    platform: linux/amd64
    container_name: selenium-chrome
    shm_size: 2gb
    ports:
      - "5900:5900"
      - "7900:7900"
    depends_on:
      selenium-hub:
        condition: service_healthy
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      SE_EVENT_BUS_HOST: selenium-hub
      SE_EVENT_BUS_PUBLISH_PORT: 4442
      SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
      SE_NODE_MAX_SESSIONS: 3
      SE_VNC_NO_PASSWORD: 1
      SE_VIDEO_RECORD: 'false'
      SE_START_XVFB: 'true'
      SE_SCREEN_WIDTH: 1920
      SE_SCREEN_HEIGHT: 1080
      JAVA_OPTS: '-Xmx512m'
      SE_NODE_SESSION_TIMEOUT: 300
      SE_LOG_LEVEL: INFO
    volumes:
      - ./selenium-videos:/videos
      - ./selenium-downloads:/home/seluser/Downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/status"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - app-network

  # ============================================================================
  # E2E TESTS - FIXED VERSION
  # ============================================================================
  e2e-tests:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    container_name: e2e-tests

    # FIX 1: REMOVED 'profiles: - testing'
    # This was preventing the container from running normally
    # profiles:
    #   - testing

    depends_on:
      selenium-hub:
        condition: service_healthy
      chrome:
        condition: service_healthy
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy

    environment:
      SELENIUM_HUB_URL: http://selenium-hub:4444
      FRONTEND_URL: http://frontend:80
      BACKEND_URL: http://backend:8080
      BROWSER: chrome
      TEST_TIMEOUT: 300
      SCREENSHOT_DIR: /app/test-output/screenshots


    # FIX 2: UNCOMMENTED volumes
    volumes:
      # FIX: Mount to /app/test-output NOT inside /app/target/
      # This avoids conflict with Maven clean
      - ./test-results:/app/test-output/results
      - ./screenshots:/app/test-output/screenshots

    networks:
      - app-network

networks:
  app-network:
    driver: bridge
    name: app-network

volumes:
  selenium-videos:
    driver: local
  selenium-downloads:
    driver: local