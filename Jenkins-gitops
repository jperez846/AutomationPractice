pipeline {
    agent any

    environment {
        // Docker Hub credentials (configure in Jenkins)
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKER_HUB_USERNAME = 'jesup19286'  // Update this!

        // Image names
        BACKEND_IMAGE = "${DOCKER_HUB_USERNAME}/product-app-backend"
        FRONTEND_IMAGE = "${DOCKER_HUB_USERNAME}/product-app-frontend"

        // Image tag (using build number + git commit)
        IMAGE_TAG = "${BUILD_NUMBER}-${GIT_COMMIT.take(7)}"

        // GitOps repository (update this!)
        GITOPS_REPO = 'https://github.com/jperez846/product-app-k8s.git'
        GITOPS_CREDENTIALS = credentials('github-credentials')

        // Test results
        TEST_RESULTS_DIR = "test-results"
        SCREENSHOTS_DIR = "target/screenshots"
    }

    stages {
        stage('Cleanup Previous Build') {
            steps {
                script {
                    echo "üßπ Cleaning up previous containers and images..."
                    sh '''
                        docker-compose down -v || true
                        docker system prune -f || true
                    '''
                }
            }
        }

        stage('Checkout Code') {
            steps {
                script {
                    echo "üì• Checking out code from repository..."
                    checkout scm
                }
            }
        }

        stage('Build Backend') {
            steps {
                script {
                    echo "üî® Building Spring Boot backend (Maven builds inside Docker)..."
                    sh '''
                        # Build Docker image with versioned tag
                        docker build -f Dockerfile.backend \
                            -t ${BACKEND_IMAGE}:${IMAGE_TAG} \
                            -t ${BACKEND_IMAGE}:latest .
                    '''
                }
            }
        }

        stage('Build Frontend') {
            steps {
                script {
                    echo "üé® Building frontend..."
                    sh '''
                        # Build Docker image with versioned tag
                        docker build -f Dockerfile.frontend \
                            -t ${FRONTEND_IMAGE}:${IMAGE_TAG} \
                            -t ${FRONTEND_IMAGE}:latest .
                    '''
                }
            }
        }

        stage('Start Services') {
            steps {
                script {
                    echo "üöÄ Starting all services (backend, frontend, Selenium Grid)..."
                    sh '''
                        # Start all core services
                        docker-compose up -d backend frontend selenium-hub chrome

                        # Wait for services to be healthy
                        echo "‚è≥ Waiting for services to become healthy..."
                        timeout=180
                        elapsed=0

                        while [ $elapsed -lt $timeout ]; do
                            backend_health=$(docker inspect --format='{{.State.Health.Status}}' backend 2>/dev/null || echo "starting")
                            frontend_health=$(docker inspect --format='{{.State.Health.Status}}' frontend 2>/dev/null || echo "starting")
                            hub_health=$(docker inspect --format='{{.State.Health.Status}}' selenium-hub 2>/dev/null || echo "starting")
                            chrome_health=$(docker inspect --format='{{.State.Health.Status}}' selenium-chrome 2>/dev/null || echo "starting")

                            if [ "$backend_health" = "healthy" ] && \
                               [ "$frontend_health" = "healthy" ] && \
                               [ "$hub_health" = "healthy" ] && \
                               [ "$chrome_health" = "healthy" ]; then
                                echo "‚úÖ All services are healthy!"
                                break
                            fi

                            echo "Status: Backend=$backend_health, Frontend=$frontend_health, Hub=$hub_health, Chrome=$chrome_health"
                            sleep 5
                            elapsed=$((elapsed + 5))
                        done

                        if [ $elapsed -ge $timeout ]; then
                            echo "‚ùå Services failed to become healthy in time"
                            docker-compose logs
                            exit 1
                        fi

                        # Show running containers
                        docker-compose ps
                    '''
                }
            }
        }

        stage('Run E2E Tests') {
            steps {
                script {
                    echo "üß™ Running E2E tests with Selenium Grid..."
                    sh '''
                        # Create directories for test artifacts
                        mkdir -p ${TEST_RESULTS_DIR}
                        mkdir -p ${SCREENSHOTS_DIR}

                        # Run E2E tests (capture exit code)
                        set +e
                        docker-compose --profile testing run --rm e2e-tests
                        TEST_EXIT_CODE=$?
                        set -e

                        # Get container ID of the test container (even if it already exited)
                        CONTAINER_ID=$(docker ps -aqf "name=e2e-tests")

                        if [ ! -z "$CONTAINER_ID" ]; then
                            echo "üì¶ Copying test artifacts from container: $CONTAINER_ID"

                            # Copy test results (surefire reports for JUnit)
                            docker cp $CONTAINER_ID:/app/target/surefire-reports/. ${TEST_RESULTS_DIR}/ 2>/dev/null || echo "‚ö†Ô∏è  No surefire reports found"

                            # Copy screenshots
                            docker cp $CONTAINER_ID:/app/target/screenshots/. ${SCREENSHOTS_DIR}/ 2>/dev/null || echo "‚ö†Ô∏è  No screenshots found"
                        else
                            echo "‚ö†Ô∏è  Warning: Could not find e2e-tests container to copy artifacts"
                        fi

                        # List what we got
                        echo "üìã Test artifacts collected:"
                        ls -la ${TEST_RESULTS_DIR}/ 2>/dev/null || echo "  (no test results)"
                        ls -la ${SCREENSHOTS_DIR}/ 2>/dev/null || echo "  (no screenshots)"

                        # Exit with test result
                        exit ${TEST_EXIT_CODE}
                    '''
                }
            }
            post {
                always {
                    // Archive test results (JUnit XML files)
                    junit allowEmptyResults: true, testResults: '**/test-results/**/*.xml, **/surefire-reports/**/*.xml'

                    // Archive screenshots
                    archiveArtifacts artifacts: 'target/screenshots/**/*.png', allowEmptyArchive: true
                }
            }
        }

        stage('Health Check Verification') {
            steps {
                script {
                    echo "üè• Verifying application health..."
                    sh '''
                        echo "Checking Backend..."
                        # Use docker exec to check from within the backend container
                        docker exec backend curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || \
                        BACKEND_STATUS=$(docker exec backend curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ 2>/dev/null || echo "000")

                        echo "Backend health check status: $BACKEND_STATUS"

                        # Backend is healthy if it responds (200, 403, or any response)
                        if docker ps | grep -q "backend.*healthy"; then
                            echo "‚úÖ Backend container is healthy"
                        else
                            echo "‚ö†Ô∏è  Backend container health check pending, but container is running"
                        fi

                        echo ""
                        echo "Checking Frontend..."
                        # Check if frontend container is healthy
                        if docker ps | grep -q "frontend.*healthy"; then
                            echo "‚úÖ Frontend container is healthy"
                        else
                            echo "‚ö†Ô∏è  Frontend container health check pending, but container is running"
                        fi

                        echo ""
                        echo "Checking Selenium Grid..."
                        # Check Selenium Hub
                        if docker exec selenium-hub curl -f -s http://localhost:4444/wd/hub/status > /dev/null 2>&1; then
                            echo "‚úÖ Selenium Grid is responding"
                        else
                            echo "‚ùå Selenium Grid not responding"
                            exit 1
                        fi

                        echo ""
                        echo "Checking Chrome Node..."
                        if docker ps | grep -q "selenium-chrome.*healthy"; then
                            echo "‚úÖ Chrome node is healthy"
                        else
                            echo "‚ö†Ô∏è  Chrome node health check pending"
                        fi

                        echo ""
                        echo "‚úÖ All critical services verified!"
                    '''
                }
            }
        }

        stage('Push to Docker Hub') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "üì§ Pushing images to Docker Hub..."
                    sh '''
                        # Login to Docker Hub
                        echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin

                        # Push versioned tags
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${FRONTEND_IMAGE}:${IMAGE_TAG}

                        # Push latest tags
                        docker push ${BACKEND_IMAGE}:latest
                        docker push ${FRONTEND_IMAGE}:latest

                        echo "‚úÖ Images pushed successfully:"
                        echo "  ${BACKEND_IMAGE}:${IMAGE_TAG}"
                        echo "  ${FRONTEND_IMAGE}:${IMAGE_TAG}"

                        # Logout
                        docker logout
                    '''
                }
            }
        }

        stage('Update GitOps Repo') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "üìù Updating Kubernetes manifests in GitOps repo..."
                    sh '''
                        # Clone GitOps repo
                        rm -rf gitops-repo
                        git clone ${GITOPS_REPO} gitops-repo
                        cd gitops-repo

                        # Configure git
                        git config user.email "jenkins@ci.local"
                        git config user.name "Jenkins CI"

                        # Update image tags in manifests
                        sed -i "s|image: ${DOCKER_HUB_USERNAME}/product-app-backend:.*|image: ${BACKEND_IMAGE}:${IMAGE_TAG}|g" manifests/backend.yaml
                        sed -i "s|image: ${DOCKER_HUB_USERNAME}/product-app-frontend:.*|image: ${FRONTEND_IMAGE}:${IMAGE_TAG}|g" manifests/frontend.yaml

                        # Check if there are changes
                        if git diff --quiet; then
                            echo "No changes to commit"
                        else
                            # Commit and push
                            git add manifests/backend.yaml manifests/frontend.yaml
                            git commit -m "Update images to ${IMAGE_TAG} [skip ci]"

                            # Push with credentials
                            git push https://${GITOPS_CREDENTIALS_USR}:${GITOPS_CREDENTIALS_PSW}@github.com/YOUR_USERNAME/product-app-k8s.git main

                            echo "‚úÖ GitOps repo updated successfully!"
                        fi

                        cd ..
                        rm -rf gitops-repo
                    '''
                }
            }
        }
    }

     post {
            always {
                script {
                    echo "üßπ Cleaning up..."
                    sh 'docker-compose down -v || true'

                    // Check build result in Groovy, not shell
                    if (currentBuild.result != 'SUCCESS' && currentBuild.result != null) {
                        echo "üìã Build failed, dumping logs for debugging..."
                        sh 'docker-compose logs --tail=100 || true'
                    }
                }
            }

            success {
                echo "‚úÖ Build ${BUILD_NUMBER} completed successfully!"
                echo "üöÄ Images: ${BACKEND_IMAGE}:${IMAGE_TAG}, ${FRONTEND_IMAGE}:${IMAGE_TAG}"
                echo "üì¶ ArgoCD will automatically deploy the new version"
            }

            failure {
                echo "‚ùå Build ${BUILD_NUMBER} failed!"
            }
        }

        success {
            echo "‚úÖ Build ${BUILD_NUMBER} completed successfully!"
            echo "üöÄ Images: ${BACKEND_IMAGE}:${IMAGE_TAG}, ${FRONTEND_IMAGE}:${IMAGE_TAG}"
            echo "üì¶ ArgoCD will automatically deploy the new version"
        }

        failure {
            echo "‚ùå Build ${BUILD_NUMBER} failed!"
        }
    }
}
